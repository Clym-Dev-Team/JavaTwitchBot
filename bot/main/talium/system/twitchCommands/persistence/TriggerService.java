package talium.system.twitchCommands.persistence;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import talium.system.twitchCommands.triggerEngine.RuntimeTrigger;
import talium.system.stringTemplates.TemplateService;
import talium.system.twitchCommands.triggerEngine.TriggerEngine;

import java.util.HashMap;
import java.util.List;
import java.util.Optional;

import static talium.system.twitchCommands.triggerEngine.TriggerProvider.transformTrigger;

@Service
public class TriggerService {
    private final TriggerRepo repo;
    private final TemplateService templateService;
    private final MessagePatternRepo messagePatternRepo;

    @Autowired
    public TriggerService(TriggerRepo triggerRepo, TemplateService templateService, MessagePatternRepo messagePatternRepo) {
        this.repo = triggerRepo;
        this.templateService = templateService;
        this.messagePatternRepo = messagePatternRepo;
    }

    public HashMap<String, TriggerEntity> getCodeTriggers() {
        HashMap<String, TriggerEntity> map = new HashMap<>();
        var list = repo.getAllByisAutoGenerated(true);
        for (var item : list) {
            map.put(item.id, item);
        }
        return map;
    }

    public HashMap<String, RuntimeTrigger> getUserTriggers() {
        HashMap<String, RuntimeTrigger> map = new HashMap<>();
        var list = repo.getAllByisAutoGenerated(false);
        for (var item : list) {
            map.put(item.id, transformTrigger(item, TriggerEngine.TEXT_COMMAND_CALLBACK));
        }
        return map;
    }

    public void removeTrigger(String id) {
        repo.deleteById(id);
    }

    @Transactional
    public void save(TriggerEntity entity) {
        var oldEntity = repo.findById(entity.id);

        for (MessagePattern pattern : entity.patterns) {
            pattern.parentTrigger = entity;
        }
        if (entity.template != null && entity.template.id != null && !entity.template.id.isBlank()) {
            templateService.save(entity.template);
        }
        repo.save(entity);
        oldEntity.ifPresent(messagePatternRepo::deleteAllByParentTrigger);
    }

    public boolean existsById(String id) {
        return repo.existsById(id);
    }

    public List<TriggerEntity> getAllUserTriggers() {
        return repo.getAllByisAutoGenerated(false);
    }

    public List<TriggerEntity> searchUserBy(String search) {
        var ids = repo.searchAllUserBy(search);
        return repo.findAllById(ids);
    }

    public List<TriggerEntity> getAllTriggers() {
        return repo.findAll();
    }

    public List<TriggerEntity> searchBy(String search) {
        var ids = repo.searchAllBy(search);
        return repo.findAllById(ids);
    }

    public Optional<TriggerEntity> getTriggersId(String id) {
        return repo.findById(id);
    }

    public void delete(String id) {
        repo.deleteById(id);
    }


    public void setEnabled(TriggerEntity trigger, boolean enabled) {
        for (MessagePattern pattern : trigger.patterns) {
            pattern.isEnabled = enabled;
        }
        repo.save(trigger);
    }

    public void setVisible(TriggerEntity trigger, boolean visible) {
        for (MessagePattern pattern : trigger.patterns) {
            pattern.isVisible = visible;
        }
        repo.save(trigger);
    }
}
